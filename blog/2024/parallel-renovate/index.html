<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Running renovate in parallel | Thorsten Hersam </title> <meta name="author" content="Thorsten Hersam"> <meta name="description" content="Automated dependency updates at scale"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%9A%80%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://uluzox.github.io/blog/2024/parallel-renovate/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Thorsten</span> Hersam </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Running renovate in parallel</h1> <p class="post-meta"> Created in May 10, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/renovate"> <i class="fa-solid fa-hashtag fa-sm"></i> renovate,</a>   <a href="/blog/tag/gitlabci"> <i class="fa-solid fa-hashtag fa-sm"></i> gitlabci</a>     ·   <a href="/blog/category/devops"> <i class="fa-solid fa-tag fa-sm"></i> devops</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="setting">Setting</h1> <p><a href="https://docs.renovatebot.com/" rel="external nofollow noopener" target="_blank">Renovate Bot</a> is an automated tool that manages software dependencies. It simplifies project maintenance by automatically updating dependencies to their latest versions through pull requests. This automation not only saves time but also enhances security by minimizing vulnerabilities associated with outdated software. Users can customize how and when updates are applied, ensuring minimal disruption to the development workflow. By maintaining dependency versions consistently and allowing configurable update rules, Renovate Bot supports stable development environments and efficient project lifecycles.</p> <p>When running Renovate on GitLab CI with the <a href="https://gitlab.com/renovate-bot/renovate-runner/-/tree/8c3e51c90522cdfdf0d504695fd63f3474e2af5a/templates" rel="external nofollow noopener" target="_blank">official GitLab CI templates</a>, the Renovate Job can easily take multiple tens of minutes to go through a project’s repositories. In the example Pipeline below, renovate scanned 52 GitLab repositories for dependencies from the below managers:</p> <ul> <li>npm</li> <li>kustomize</li> <li>dockerfile</li> <li>composer</li> <li>gitlabci</li> <li>gitlabci-include</li> <li>terraform</li> <li>terraform-version</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/blog/2024-05-10-parallel-renovate/renovate-single-process-length-480.webp 480w,/assets/blog/2024-05-10-parallel-renovate/renovate-single-process-length-800.webp 800w,/assets/blog/2024-05-10-parallel-renovate/renovate-single-process-length-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/blog/2024-05-10-parallel-renovate/renovate-single-process-length.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>With roughly 30 minutes of execution time, we can schedule this pipeline only about once an hour. In the project, renovate is not only used to update dependencies from external projects but also from our own project’s application components. Therefore, once an hour is the maximum acceptable schedule. At this stage of the project we knew that there were many more repositories to be created. Thus there was an urge for optimisation of the renovate pipeline.</p> <h1 id="setup">Setup</h1> <p>We will have two repositories:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">renovate-image</code>, for building a custom renovate container image</li> <li> <code class="language-plaintext highlighter-rouge">renovate-bot</code>, for holding renovate default configuration and this is were the pipeline runs</li> </ul> <h2 id="renovate-image">renovate-image</h2> <p>A custom renovate container image is needed for two reasons. First, we need to add a <code class="language-plaintext highlighter-rouge">.gitlab-ci.yaml</code> template to the image to construct a dynamic GitLab CI Job. Second, we can add extra tools to the image to run renovate <a href="https://docs.renovatebot.com/configuration-options/#postupgradetasks" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">postUpgradeTasks</code></a>.</p> <p><code class="language-plaintext highlighter-rouge">/Dockerfile</code> <script src="https://gist.github.com/uluzox/aa26e82b11b6e5093ae59d9e09e9e0c1.js"></script></p> <p><code class="language-plaintext highlighter-rouge">/template/.gitlab-ci.yml</code> <script src="https://gist.github.com/uluzox/bf1a1c574369e411b89aa46adf8486fc.js"></script></p> <h2 id="renovate-bot">renovate-bot</h2> <p>The definition of the <code class="language-plaintext highlighter-rouge">image</code> is placed into an extra file called <code class="language-plaintext highlighter-rouge">.template.gitlab-ci.yml</code>. This way we can, <code class="language-plaintext highlighter-rouge">extend</code> from the <code class="language-plaintext highlighter-rouge">.template</code> job by <code class="language-plaintext highlighter-rouge">include</code>ing the <code class="language-plaintext highlighter-rouge">.template.gitlab-ci.yml</code> file into a pipeline configuration from <code class="language-plaintext highlighter-rouge">local</code> and from <code class="language-plaintext highlighter-rouge">project</code> (see <code class="language-plaintext highlighter-rouge">/template/.gitlab-ci.yml</code> in <a href="#renovate-image">renovate-image</a>.</p> <p><code class="language-plaintext highlighter-rouge">.template.gitlab-ci.yml</code> <script src="https://gist.github.com/uluzox/5424aeabf41ebb3cdf61f07450214ba6.js"></script></p> <p>Moreover, by adapting renovate <code class="language-plaintext highlighter-rouge">gitlab-ci</code> manager configuration in the <code class="language-plaintext highlighter-rouge">renovate.json</code> we can ensure updates to the <code class="language-plaintext highlighter-rouge">image</code>. The below regex matches both <code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code> and <code class="language-plaintext highlighter-rouge">.template.gitlab-ci.yml</code> files.</p> <p><code class="language-plaintext highlighter-rouge">renovate.json</code></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"gitlabci"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"fileMatch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"(</span><span class="se">\\</span><span class="s2">..+)?</span><span class="se">\\</span><span class="s2">.gitlab-ci</span><span class="se">\\</span><span class="s2">.ya?ml$"</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Now, the actual renovate pipeline, includes the above template and defines three jobs.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">renovate-config-validator</code> is for validating the renovate configuration.</li> <li> <code class="language-plaintext highlighter-rouge">renovate:discover</code> finds all repositories which dependencies shall be scanned by renovate. Furthermore, it creates a GitLab CI pipeline file named <code class="language-plaintext highlighter-rouge">.gitlab-renovate-repos.yml</code> from the <code class="language-plaintext highlighter-rouge">template/.gitlab-ci.yml</code> and replaces the placeholder <code class="language-plaintext highlighter-rouge">###RENOVATE_REPOS###</code> with the discovered repositories.</li> <li> <code class="language-plaintext highlighter-rouge">renovate:repos</code> uses the <code class="language-plaintext highlighter-rouge">.gitlab-renovate-repos.yml</code> from the <code class="language-plaintext highlighter-rouge">renovate:discover</code> job to trigger the jobs defined in the pipeline configuration.</li> </ul> <p><code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code> <script src="https://gist.github.com/uluzox/0f62f7a318e391b3265dcf148f75ca61.js"></script></p> <h1 id="results">Results</h1> <p>55 GitLab repositories are now scanned for dependencies (and updated) by renovate in 8 Minutes.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-1-480.webp 480w,/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-1-800.webp 800w,/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-2-480.webp 480w,/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-2-800.webp 800w,/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/blog/2024-05-10-parallel-renovate/renovate-single-parallel-length-2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h1 id="sources">Sources</h1> <ul> <li><a href="https://medium.com/notive/optimizing-renovate-for-gitlab-with-500-repositories-6d225f24ff79" rel="external nofollow noopener" target="_blank">Medium: Optimizing Renovate for GitLab with 500+ Repositories</a></li> </ul> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Thorsten Hersam. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>